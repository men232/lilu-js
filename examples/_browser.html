<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <pre id="result">Checking access...</pre>
</body>
<script src="../dist/lilu.umd.js"></script>
<script>
  const user = {
    id: 1,
    name: 'Andrew L.',
    email: 'andrew.io.dev@gmail.com',
    role: ['ROLE_USER']
  };

  const order = {
    title: 'Netflix Subscription',
    owner: 1,
    placedAt: new Date(),
    items: [1, 2, 3, 4]
  };

  const permissions = [{
    title: 'Order Review',
    actions: ['order.view'],
    rules: [{
      title: 'Owned',
      operation: 'AND',
      conditions: [
        'order.owner in [user.id, 3, 5, 6]',
      ]
    }, {
      title: 'Working Time',
      operation: 'AND',
      conditions: [
        'env.hours >= 8',
        'env.hours <= 18',
      ]
    }]
  }, {
    title: 'Order Create',
    actions: ['order.create'],
    rules: [{
      title: 'Owned',
      operation: 'AND',
      conditions: [
        'env.hours >= 8',
        'env.hours <= 18',
      ]
    }]
  }];

  const delay = (ms) => {
    return new Promise((resolve) => {
      setTimeout(resolve, ms);
    });
  }

  const lilu = window.lilu({
    strict: true,
    enviroment: {
      env: {
        hours: () => delay(400).then(() => (new Date()).getHours()),
        minutes: () => delay(400).then(() => (new Date()).getMinutes())
      },
      user: user
    },
    permissions: permissions
  });

  lilu.grantedMany('order.*', { context: { order } }, function(err, result) {
    let html = '';

    if (err) {
      html = '<span style="color: red">(Error)</span>\n' + err.toString();
    } else {
      html = result.trace.toString();
    }

    document.getElementById('result').innerHTML = html;
    console.log(html);
  });
</script>
</html>
