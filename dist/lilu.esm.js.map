{"version":3,"file":"lilu.esm.js","sources":["../src/utils/object.js","../src/utils/array.js","../src/utils/promiseOrCallback.js","../src/utils/promiseDelay.js","../src/error/LiluExpressionEvalError.js","../src/error/LiluExpressionParserError.js","../src/error/LiluTimeoutError.js","../src/utils/promiseTimeout.js","../src/utils/timer.js","../src/LiLuExpression/parse.js","../src/LiLuExpression/eval.js","../src/LiLuExpression/validate.js","../src/LiLuExpression/operators.js","../src/LiLuExpression/index.js","../src/utils/format.js","../src/utils/tbag.js","../src/LiluPermission/LiluPermissionRule.js","../src/LiluPermission/index.js","../src/index.js"],"sourcesContent":["import cloneDeep from 'clone-deep';\n\nexport { cloneDeep as clone };\n\nexport function isEmptyObject(obj) {\n  return Object.keys(obj).length === 0;\n}\n\nexport function set(obj, path, value) {\n  if (Object(obj) !== obj) return obj;\n  // If not yet an array, get the keys from the string-path\n  if (!Array.isArray(path)) path = path.toString().match(/[^.[\\]]+/g) || [];\n\n  path.slice(0,-1).reduce((a, c, i) => // Iterate all of them except the last one\n   Object(a[c]) === a[c] // Does the key exist and is its value an object?\n       // Yes: then follow that path\n       ? a[c]\n       // No: create the key. Is the next key a potential array-index?\n       : a[c] = Math.abs(path[i+1])>>0 === +path[i+1]\n             ? [] // Yes: assign a new array object\n             : {}, // No: assign a new plain object\n   obj)[path[path.length-1]] = value; // Finally assign the value to the last key\n\n  return obj; // Return the top-level object to allow chaining\n}\n\nexport function get(obj, path, defaultValue = undefined) {\n  const travel = regexp =>\n    String.prototype.split\n      .call(path, regexp)\n      .filter(Boolean)\n      .reduce((res, key) => (res !== null && res !== undefined ? res[key] : res), obj);\n\n  const result = travel(/[,[\\]]+?/) || travel(/[,[\\].]+?/);\n\n  return result === undefined || result === obj ? defaultValue : result;\n}\n\nexport function pick(obj, list) {\n  const result = {};\n\n  for(const key of list) {\n    result[key] = get(obj, key);\n  }\n\n  return result;\n}\n\nexport function defineGetter(obj, key, getterFn) {\n  delete obj[key];\n\n  Object.defineProperty(obj, key, {\n    get: getterFn,\n    enumerable: true,\n    configurable: true\n  });\n}\n","export function uniq(arr) {\n  return [...new Set(arr)];\n}\n\nexport function pull(items, valuesToRemove) {\n  return items.filter(item => !valuesToRemove.includes(item));\n}\n","export default function promiseOrCallback(callback, fn) {\n  if (typeof callback === 'function') {\n    return fn(function(error) {\n      if (error != null) {\n        try {\n          callback(error);\n        } catch (error) {\n          return process.nextTick(() => {\n            throw error;\n          });\n        }\n        return;\n      }\n      callback.apply(this, arguments);\n    });\n  }\n\n  return new Promise((resolve, reject) => {\n    fn(function(error, res) {\n      if (error !== null) {\n        return reject(error);\n      }\n      if (arguments.length > 2) {\n        return resolve(Array.prototype.slice.call(arguments, 1));\n      }\n      resolve(res);\n    });\n  });\n}\n","export default function promiseDelay(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n","class LiluExpressionEvalError extends Error {\n  constructor(message, expressionText, context, code) {\n    super(message);\n\n    this.expressionText = expressionText || null;\n    this.context = context || null;\n    this.code = code || -1;\n  }\n\n  /**\n   * Console.log helper\n   */\n  toString() {\n    return `${this.name} (${this.expressionText}): ${this.message}`;\n  }\n\n  /*!\n   * inspect helper\n   */\n  inspect() {\n    return Object.assign(new Error(this.message), this);\n  }\n}\n\n/*!\n * Helper for JSON.stringify\n */\nObject.defineProperty(LiluExpressionEvalError.prototype, 'toJSON', {\n  enumerable: false,\n  writable: false,\n  configurable: true,\n  value: function() {\n    return Object.assign({}, this, {\n      message: this.message,\n      expressionText: this.expressionText,\n      context: this.context,\n      code: this.code\n    });\n  }\n});\n\nObject.defineProperty(LiluExpressionEvalError.prototype, 'name', {\n  value: 'LiluExpressionEvalError'\n});\n\nexport default LiluExpressionEvalError;\n","class LiluExpressionParserError extends Error {\n  constructor(message, expressionText, code) {\n    super(message);\n\n    this.expressionText = expressionText || null;\n    this.code = code || -1;\n  }\n\n  /**\n   * Console.log helper\n   */\n  toString() {\n    return `${this.name} (${this.expressionText}): ${this.message}`;\n  }\n\n  /*!\n   * inspect helper\n   */\n  inspect() {\n    return Object.assign(new Error(this.message), this);\n  }\n}\n\n/*!\n * Helper for JSON.stringify\n */\nObject.defineProperty(LiluExpressionParserError.prototype, 'toJSON', {\n  enumerable: false,\n  writable: false,\n  configurable: true,\n  value: function() {\n    return Object.assign({}, this, {\n      message: this.message,\n      expressionText: this.expressionText,\n      code: this.code\n    });\n  }\n});\n\nObject.defineProperty(LiluExpressionParserError.prototype, 'name', {\n  value: 'LiluExpressionParserError'\n});\n\nexport default LiluExpressionParserError;\n","class LiluTimeoutError extends Error {\n  constructor(message, code) {\n    super(message);\n\n    this.code = code || -1;\n  }\n\n  /**\n   * Console.log helper\n   */\n  toString() {\n    return `${this.name}: ${this.message}`;\n  }\n\n  /*!\n   * inspect helper\n   */\n  inspect() {\n    return Object.assign(new Error(this.message), this);\n  }\n}\n\n/*!\n * Helper for JSON.stringify\n */\nObject.defineProperty(LiluTimeoutError.prototype, 'toJSON', {\n  enumerable: false,\n  writable: false,\n  configurable: true,\n  value: function() {\n    return Object.assign({}, this, {\n      message: this.message,\n      code: this.code\n    });\n  }\n});\n\nObject.defineProperty(LiluTimeoutError.prototype, 'name', {\n  value: 'LiluTimeoutError'\n});\n\nexport default LiluTimeoutError;\n","import { LiluTimeoutError } from '../error';\n\nexport default function promiseTimeout(promise, timeoutMillis, message) {\n  let error = new LiluTimeoutError(message || 'Timeout error');\n  let timeout;\n\n  return Promise.race([\n    promise,\n    new Promise(function(resolve, reject) {\n      timeout = setTimeout(function() {\n        reject(error);\n      }, timeoutMillis);\n    }),\n  ]).then(function(v) {\n    clearTimeout(timeout);\n    return v;\n  }, function(err) {\n    clearTimeout(timeout);\n    throw err;\n  });\n}\n","export default function timer() {\n  let startAt = Date.now();\n\n  const instance = {\n    reset: () => {\n      startAt = Date.now();\n\n      return instance;\n    },\n    click: () => Date.now() - startAt\n  };\n\n  return instance;\n}\n","import debug from 'debug';\nimport evaluate from 'static-eval';\nimport esprima from 'esprima';\n\nimport * as array from '../utils/array';\n\n// eslint-disable-next-line no-useless-escape\nconst EXPRESSION_REG_EXP = /(\\{\\{(.*?)\\}\\}|\\[.*?\\]|\\\".*?\\\"|[^\\s]+)/g;\n\nconst dParse = debug('lilu:expression:parse');\nconst dCast = debug('lilu:expression:cast');\n\nexport default function parseExpression() {\n  const str = String(this._raw);\n\n  const matchResult = Array.from(str.matchAll(EXPRESSION_REG_EXP));\n\n  dParse('LINE = \"%s\"', str);\n\n  const parsed = [];\n  const variables = [];\n\n  for(const match of matchResult) {\n    const str = (match[3] || match[2] || match[1] || 'null').trim();\n\n    let type = 'unknown';\n    let value = null;\n\n    if (!match || !match[0]) {\n      // noting\n    } else {\n      [value, type] = castExpression.call(this, str);\n    }\n\n    dCast('STR = \"%s\"\\n    TYPE = %s\\n    RESULT = %o', str, type, value);\n\n    parsed.push({ type, value, raw: str });\n\n    if (type === 'variable') {\n      variables.push(value);\n    } else if (type === 'expression') {\n      variables.push(\n        ...extractEsprimaVariables(value)\n      );\n    }\n  }\n\n  this._parsed = parsed;\n  this._variables = array.uniq(variables); // make uniq\n}\n\nfunction extractEsprimaVariables(expression) {\n  const list = [];\n\n  if (expression.type === 'Identifier') {\n    list.push(expression.name);\n  } else if (expression.type === 'BinaryExpression') {\n    for(const el of [expression.left, expression.right]) {\n      list.push(...extractEsprimaVariables(el));\n    }\n  } else if (expression.type === 'MemberExpression') {\n    list.push(`${expression.object.name}.${expression.property.name}`);\n  } else if (expression.elements) {\n    for(const el of expression.elements) {\n      list.push(...extractEsprimaVariables(el));\n    }\n  }\n\n  return list;\n}\n\nfunction castExpression(str) {\n  try {\n    let type = 'unknown';\n    let value = str;\n\n    if (this._operators[str]) {\n      return [str, 'operator'];\n    }\n\n    const ast = esprima.parse(str).body[0].expression;\n\n    switch (true) {\n      case ast.type === 'Identifier' || ast.type === 'MemberExpression':\n        type = 'variable';\n        break;\n\n      case ast.type === 'Literal':\n        value = evaluate(ast);\n        type = castType(value);\n        break;\n\n      case ast.type === 'ArrayExpression' || ast.type === 'BinaryExpression':\n        value = ast;\n        type = 'expression';\n        break;\n    }\n\n    return [value, type];\n  } catch (_) {\n    return [str, 'unknown'];\n  }\n}\n\nfunction castType(value) {\n  switch (true) {\n    case value === null:\n      return 'null';\n\n    case Array.isArray(value):\n      return 'array';\n\n    default:\n      return typeof value;\n  }\n}\n","import evaluate from 'static-eval';\nimport debug from 'debug';\n\nimport * as obj from '../utils/object';\nimport { LiluExpressionEvalError } from '../error';\n\nconst d = debug('lilu:expression:eval');\nconst dError = debug('lilu:expression:eval:error');\n\nexport default function evalExpression(context = {}) {\n  this.validate();\n\n  if (this.strict) {\n    const missedContextKey = this._variables.find(\n      (keyPath) => obj.get(context, keyPath) === undefined\n    );\n\n    if (missedContextKey) {\n      dError('Failed to eval \"%s\", \"%s\" has missed in context: %o',\n        this._raw, missedContextKey, context);\n\n      throw new LiluExpressionEvalError(\n        `Detected missed variable: \"${missedContextKey}\" has required in strict mode.`,\n        this._raw,\n        context\n      );\n    }\n  }\n\n  const [left, operator, right] = this._parsed;\n\n  let leftValue = ensureValue(left, context);\n  let rightValue = ensureValue(right, context);\n\n  const operatorFn = this._operators[operator.value];\n\n  try {\n    const result = operatorFn(leftValue, rightValue);\n\n    d('%s %s %s RESULT = %s\\n    BY VALUES:\\n      “%s” = %o\\n      “%s” = %o',\n      left.raw,\n      operator.value,\n      right.raw,\n      result,\n      left.raw,\n      leftValue,\n      right.raw,\n      rightValue\n    );\n\n    return {\n      left: { ...left, ensured: leftValue },\n      right: { ...right, ensured: rightValue },\n      operator: operator.value,\n      result\n    };\n  } catch (err) {\n    dError('%s %s %s ERROR = %s\\n    BY VALUES:\\n      “%s” = %o\\n      “%s” = %o',\n      left.raw,\n      operator.value,\n      right.raw,\n      err.message,\n      left.raw,\n      leftValue,\n      right.raw,\n      rightValue\n    );\n\n    throw new LiluExpressionEvalError(\n      `Execution error: ${err.message}`,\n      this._raw,\n      context\n    );\n  }\n}\n\nfunction ensureValue({ type, value }, context) {\n  switch (type) {\n    case 'variable':\n      return obj.get(context, value);\n\n   case 'expression':\n     return evaluate(value, context);\n\n    default:\n      return value;\n  }\n}\n","import { LiluExpressionParserError } from '../error';\n\nexport default function validateExpression() {\n  if (this._parsed === null) {\n    this.parse();\n  }\n\n  if (!this._parsed || !Array.isArray(this._parsed)) {\n    throw new LiluExpressionParserError(\n      `Unknown error while parsing an expression.`, raw);\n  }\n\n  const raw = this._raw;\n  const parsed = this._parsed;\n\n  switch (true) {\n    case parsed.length !== 3:\n      throw new LiluExpressionParserError(\n        `Expect 3 parts of expression, parsed: ${parsed.length}`, raw);\n\n    case parsed[0].type === 'operator':\n      throw new LiluExpressionParserError(\n        `The first part of expression is operator.`, raw);\n\n    case parsed[0].type === 'unknown':\n      throw new LiluExpressionParserError(\n        `The first part of expression is unknown.`, raw);\n\n    case parsed[1].type !== 'operator':\n      throw new LiluExpressionParserError(\n        `The second part of expression must be an operator, parsed: ${parsed[1].type}.`, raw);\n\n    case typeof this._operators[parsed[1].value] !== 'function':\n      throw new LiluExpressionParserError(\n        `The second part operator has unknown, parsed: ${parsed[1].value}.`, raw);\n\n    case parsed[2].type === 'unknown':\n      throw new LiluExpressionParserError(\n        `The third part of expression is unknown.`, raw);\n\n    case parsed[2].type === 'operator':\n      throw new LiluExpressionParserError(\n        `The third part of expression is operator.`, raw);\n\n    default:\n      return true;\n  }\n}\n","export default {\n  '>': (leftValue, rightValue) => {\n    return leftValue > rightValue;\n  },\n\n  '>=': (leftValue, rightValue) => {\n    return leftValue > rightValue;\n  },\n\n  '<': (leftValue, rightValue) => {\n    return leftValue < rightValue;\n  },\n\n  '<=': (leftValue, rightValue) => {\n    return leftValue <= rightValue;\n  },\n\n  '==': (leftValue, rightValue) => {\n    return leftValue === rightValue;\n  },\n\n  '!=': (leftValue, rightValue) => {\n    return leftValue !== rightValue;\n  },\n\n  'in': (leftValue, rightValue) => {\n    if (!Array.isArray(leftValue)) leftValue = [leftValue];\n    if (!Array.isArray(rightValue)) rightValue = [rightValue];\n\n    return leftValue.some(value => rightValue.indexOf(value) > -1);\n  }\n};\n","import * as obj from '../utils/object';\nimport parse from './parse';\nimport evalExpression from './eval';\nimport validate from './validate';\nimport EXPRESSION_OPERATORS from './operators';\n\nexport default class LiLuExpression {\n  constructor(str, options = {}) {\n    if (typeof str === 'object') {\n      options = str;\n      str = options.str;\n    }\n\n    this._raw = str;\n    this._parsed = null;\n    this._variables = [];\n    this.strict = options.strict || false;\n    this._operators = obj.clone(options.operators || EXPRESSION_OPERATORS);\n\n    this.parse();\n\n    if (this.strict) {\n      this.validate();\n    }\n  }\n\n  get raw() {\n    return this._raw;\n  }\n\n  get variables() {\n    return [...this._variables];\n  }\n\n  get isValid() {\n    try {\n      this.validate();\n      return true;\n    } catch (err) {\n      return false;\n    }\n  }\n\n  /**\n   * Console.log helper\n   */\n  toString() {\n    return `${this.name} (${this._raw}): VALID = ${this.isValid} VARS = ${this._variables.join(', ')}`;\n  }\n\n  /*!\n   * inspect helper\n   */\n  inspect() {\n    return Object.assign({}, this);\n  }\n\n  parse = parse;\n  eval = evalExpression;\n  validate = validate;\n}\n\n/*!\n * Helper for JSON.stringify\n */\nObject.defineProperty(LiLuExpression.prototype, 'toJSON', {\n  enumerable: false,\n  writable: false,\n  configurable: true,\n  value: function() {\n    return {\n      name: this.name,\n      strict: this.strict,\n      str: this.raw,\n      variables: this.variables,\n      operators: Object.keys(this._operators),\n      isValid: this.isValid\n    };\n  }\n});\n\nObject.defineProperty(LiLuExpression.prototype, 'name', {\n  value: 'LiLuExpression'\n});\n","export default function format(fmt, ...args) {\n  const re = /(%?)(%([jdsoO]))/g;\n\n  if (args.length) {\n    fmt = fmt.replace(re, (match, escaped, ptn, flag) => {\n      let arg = args.shift();\n      switch(flag) {\n        case 's':\n          arg = '' + arg;\n          break;\n        case 'd':\n          arg = Number(arg);\n          break;\n        case 'j':\n          arg = JSON.stringify(arg);\n          break;\n        case 'o':\n          arg = JSON.stringify(arg);\n          break;\n        case 'O':\n          arg = JSON.stringify(arg, null, 2);\n          break;\n      }\n      if(!escaped) {\n        return arg;\n      }\n      args.unshift(arg);\n      return match;\n    })\n  }\n\n  if (args.length) {\n    fmt += ' ' + args.join(' ');\n  }\n\n  // update escaped %% values\n  fmt = fmt.replace(/%{2}/g, '%');\n\n  return '' + fmt;\n}\n","import format from './format';\n\nexport default function createTBag() {\n  const rootChilds = [];\n  const lines = [];\n\n  const collect = ({ lines, childs }, pad = 0) => {\n    if (!lines.length && !childs.length) {\n      return '';\n    }\n\n    const p = ''.padStart(pad, ' ');\n\n    let result = '\\n' + p + lines.join('\\n' + p);\n\n    for(const item of childs) {\n      result += '\\n' + ''.padStart(pad) + '  ' + collect(item, pad + 2);\n    }\n\n    return result.trim();\n  };\n\n  const rootCollect = () => collect({ lines, childs: rootChilds });\n\n  return {\n    w(...args) {\n        const line = format(...args);\n\n      lines.push(...line.split('\\n'));\n\n      return this;\n    },\n    attach(instance) {\n      return this.child(instance);\n    },\n    child(instance) {\n      instance = instance || createTBag();\n\n      instance.isChild = true;\n      instance.collect = this.isChild\n        ? this.collect\n        : rootCollect;\n\n      rootChilds.push(instance);\n\n      return instance;\n    },\n    childs: rootChilds,\n    lines: lines,\n    collect: rootCollect,\n    str: () => collect({ lines, childs: rootChilds })\n  }\n}\n\n/*\n  const t = createTBag();\n\n  console.log(\n  t\n    .w('line 1')\n    .w('line 2')\n    .w('line 3')\n    .w('line 4')\n    .child()\n    .w('line 1.1 with\\n * some 1\\n * some 2')\n    .w('line 1.2')\n    .w('line 1.3')\n    .w('line 1.4')\n    .child()\n    .w('line 2.1')\n    .w('line 2.2')\n    .w('line 2.3')\n    .w('line 2.4')\n    .collect()\n  );\n  console.log('-----');\n  console.log(t.collect())\n */\n","import * as array from '../utils/array';\nimport LiLuExpression from '../LiLuExpression';\nimport tbag from '../utils/tbag';\nimport timer from '../utils/timer';\n\nexport default class LiluPermissionRule {\n  constructor(options = {}, operators, strict = false) {\n    this.title = options.title || 'Untitled Rule';\n\n    this.operation = options.operation || 'AND';\n\n    this.conditions = (options.conditions || [])\n      .map(cond => new LiLuExpression(cond, { operators, strict }));\n\n    this._conditionVariables = array.uniq(\n      this.conditions.map(condition => condition.variables).flat()\n    );\n  }\n\n  get conditionVariables() {\n    return [...this._conditionVariables];\n  }\n\n  match(context) {\n    const trace = [];\n    const operation = this.operation;\n    const tRoot = tbag();\n    const tCond = tRoot.child();\n\n    let matched;\n\n    const conditionRun = (condition) => {\n      const r = condition.eval(context);\n\n      tCond.w('CONDITION %o PASSED = %o\\n • BY VALUES:\\n   • “%s” = %o\\n   • “%s” = %o',\n        condition.raw,\n        r.result,\n        r.left.raw,\n        r.left.ensured,\n        r.right.raw,\n        r.right.ensured\n      );\n\n      trace.push({\n        type: 'condition',\n        item: condition.toJSON(),\n        evalResult: r\n      });\n\n      return r.result === true;\n    };\n\n    const matchTimer = timer();\n\n    if (this.operation === 'OR') {\n      matched = this.conditions.some(conditionRun);\n    } else {\n      matched = this.conditions.every(conditionRun);\n    }\n\n    const ms = matchTimer.click();\n\n    tRoot.w('RULE %o RESULT = %o (%d ms)',\n      this.title,\n      matched,\n      ms\n    );\n\n    return {\n      matched,\n      operation,\n      trace,\n      ms,\n      t: tRoot,\n    };\n  }\n\n  /**\n   * Console.log helper\n   */\n  toString(_, pad = 0) {\n    const sep = '- '.padStart(pad + 4, ' ');\n    const conditions = sep + this.conditions.join('\\n' + sep);\n    return `${this.name} (${this.title}):\\n${conditions}`;\n  }\n\n  /*!\n   * inspect helper\n   */\n  inspect() {\n    return Object.assign({}, this);\n  }\n}\n\n/*!\n * Helper for JSON.stringify\n */\nObject.defineProperty(LiluPermissionRule.prototype, 'toJSON', {\n  enumerable: false,\n  writable: false,\n  configurable: true,\n  value: function() {\n    return {\n      name: this.name,\n      title: this.title,\n      operation: this.operation,\n      conditions: this.conditions.map(v => v._raw)\n    };\n  }\n});\n\nObject.defineProperty(LiluPermissionRule.prototype, 'name', {\n  value: 'LiluPermissionRule'\n});\n","import * as array from '../utils/array';\nimport * as obj from '../utils/object';\nimport timer from '../utils/timer';\nimport LiluPermissionRule from './LiluPermissionRule';\nimport tbag from '../utils/tbag';\n\nexport default class LiluPermission {\n  constructor(options = {}, operators, strict = false) {\n    this.title = options.title || 'Untitled Permission';\n\n    this.actions = obj.clone(options.actions || []);\n\n    this._attributes = obj.clone(options.attributes || {});\n\n    this.rules = (options.rules || [])\n      .map(rule => new LiluPermissionRule(rule, operators, strict));\n\n    this._ruleVariables = array.uniq(\n      this.rules.map(rule => rule.conditionVariables).flat()\n    );\n  }\n\n  get ruleVariables() {\n    return obj.clone(this._ruleVariables);\n  }\n\n  get attributes() {\n    return obj.clone(this._attributes);\n  }\n\n  check(context) {\n    const tRoot = tbag();\n    const trace = [];\n\n    const ruleRun = (rule) => {\n      const result = rule.match(context);\n\n      tRoot.attach(result.t);\n\n      trace.push({\n        type: 'rule',\n        item: rule.toJSON(),\n        ...result,\n        ms\n      });\n\n      return result.matched;\n    };\n\n    const startTimer = timer();\n    const isAllRulesPassed = this.rules.every(ruleRun);\n    const ms = startTimer.click();\n\n    tRoot.w('PERMISSION %o\\n • PASSED: %o (%d ms)',\n      this.title,\n      isAllRulesPassed,\n      ms\n    );\n\n    return {\n      passed: isAllRulesPassed,\n      context,\n      trace,\n      t: tRoot,\n      ms\n    };\n  }\n\n  /**\n   * Console.log helper\n   */\n  toString(_, pad = 0) {\n    const actions = `\"${this.actions.join('\", \"')}\"`;\n    const sep = '- '.padStart(pad + 4, ' ');\n    const rules = sep + this.rules\n      .map(v => v.toString(null, pad + 4))\n      .join('\\n' + sep);\n\n    return `${this.name} (${this.title}): [${actions}]\\n${rules}`;\n  }\n\n  /*!\n   * inspect helper\n   */\n  inspect() {\n    return Object.assign({}, this);\n  }\n}\n\n/*!\n * Helper for JSON.stringify\n */\nObject.defineProperty(LiluPermission.prototype, 'toJSON', {\n  enumerable: false,\n  writable: false,\n  configurable: true,\n  value: function() {\n    return {\n      name: this.name,\n      title: this.title,\n      actions: obj.clone(this.actions),\n      attributes: obj.clone(this._attributes),\n      rules: this.rules.map(v => v.toJSON())\n    };\n  }\n});\n\nObject.defineProperty(LiluPermission.prototype, 'name', {\n  value: 'LiluPermission'\n});\n","import debug from 'debug';\nimport globToRegExp from 'glob-to-regexp';\n\nimport * as obj from './utils/object';\nimport * as array from './utils/array';\nimport promiseOrCallback from './utils/promiseOrCallback';\nimport promiseDelay from './utils/promiseDelay';\nimport promiseTimeout from './utils/promiseTimeout';\nimport timer from './utils/timer';\n\nimport LiluPermission from './LiluPermission';\nimport EXPRESSION_OPERATORS from './LiLuExpression/operators';\nimport tbag from './utils/tbag';\n\nconst d = debug('lilu:permission');\n\nexport class Lilu {\n  constructor(options = {}) {\n    // eslint-disable no-multi-spaces\n    this.strict      = options.strict || false;                              // eslint-disable-line\n    this._timeout    = options.timeout || 0;                                 // eslint-disable-line\n    this._enviroment = obj.clone(options.enviroment || {});                  // eslint-disable-line\n    this._operators  = obj.clone(options.operators || EXPRESSION_OPERATORS); // eslint-disable-line\n\n    if (Array.isArray(this._operators)) {\n      this._operators = obj.pick(EXPRESSION_OPERATORS, this._operators);\n    }\n\n    this._permissionsByActionMap = new Map();\n    this._permissions = (options.permissions || []).map(permissionOptions => {\n      const permission = new LiluPermission(\n        permissionOptions,\n        this._operators,\n        this.strict\n      );\n\n      for(const actionName of permission.actions) {\n        const list = this._permissionsByActionMap.get(actionName) || [];\n\n        list.push(permission);\n\n        this._permissionsByActionMap.set(actionName, list);\n      }\n\n      return permission;\n    });\n\n  }\n\n  get permissions() {\n    return [...this._permissions];\n  }\n\n  findActions(value) {\n    const startTimer = timer();\n\n    let pattern = value;\n\n    if (typeof value === 'string') {\n      pattern = globToRegExp(value, { extended: true });\n    }\n\n    if (!(pattern instanceof RegExp)) {\n      throw new TypeError(\n        'Failed to find actions, the value argument expected as regexp or string.'\n      );\n    }\n\n    const list = [];\n\n    for(const value of this._permissionsByActionMap.keys()) {\n      if (pattern.test(value)) {\n        list.push(value);\n      }\n    }\n\n    const ms = startTimer.click();\n\n    d('FIND ACTIONS: (%dms)\\n  VALUE = %o\\n  PATTERN = %o\\n  RESULT: %o',\n      ms, value, pattern, list);\n\n    return list;\n  }\n\n  granted(actionName, params, callback) {\n    if (typeof actionName !== 'string') {\n      throw new TypeError('First argument \"actionName\" expected as String.');\n    }\n\n    if (typeof params === 'function') {\n      callback = params;\n      params = null;\n    }\n\n    const options = {\n      timeout: this._timeout || false,\n      context: params\n    };\n\n    if (params && params.context !== undefined) {\n      Object.assign(options, params);\n    }\n\n    return promiseOrCallback(callback, cb => {\n      this._granted(actionName, options).then(cb.bind(null, null), cb);\n    });\n  }\n\n  grantedMany(actions, params, callback) {\n    if (typeof actions === 'string') {\n      if (actions.indexOf('*') > -1) {\n        const pattern = actions;\n        actions = this.findActions(pattern);\n      } else {\n        actions = [actions];\n      }\n    } else if (actions instanceof RegExp) {\n      const pattern = actions;\n\n      actions = this.findActions(pattern);\n    }\n\n    if (!Array.isArray(actions)) {\n      throw new TypeError('First argument \"actions\" expected as Array.');\n    }\n\n    if (typeof params === 'function') {\n      callback = params;\n      params = null;\n    }\n\n    const options = {\n      timeout: this._timeout || false,\n      context: params\n    };\n\n    if (params && params.context !== undefined) {\n      Object.assign(options, params);\n    }\n\n    return promiseOrCallback(callback, cb => {\n      this._grantedMany(actions, options).then(cb.bind(null, null), cb);\n    });\n  }\n\n  grantedAny(actions, params, callback) {\n    if (typeof actions === 'string') {\n      if (actions.indexOf('*') > -1) {\n        const pattern = actions;\n        actions = this.findActions(pattern);\n      } else {\n        actions = [actions];\n      }\n    } else if (actions instanceof RegExp) {\n      const pattern = actions;\n\n      actions = this.findActions(pattern);\n    }\n\n    if (!Array.isArray(actions)) {\n      throw new TypeError('First argument \"actions\" expected as Array.');\n    }\n\n    if (typeof params === 'function') {\n      callback = params;\n      params = null;\n    }\n\n    const options = {\n      timeout: this._timeout || false,\n      context: params\n    };\n\n    if (params && params.context !== undefined) {\n      Object.assign(options, params);\n    }\n\n    return promiseOrCallback(callback, cb => {\n      this._grantedAny(actions, options).then(cb.bind(null, null), cb);\n    });\n  }\n\n  async _grantedAny(actions, options = {}) {\n    options = options || {};\n\n    const tRoot = tbag();\n    const trace = [];\n\n    const startTimer = timer();\n\n    let result = null;\n\n    for(const actionName of actions) {\n      const opts = { ...options };\n\n      if (opts.timeout) {\n        opts.timeout = opts.timeout - startTimer.click();\n      }\n\n      result = await this._granted(actionName, opts);\n\n      tRoot.childs.push(...result.t.childs);\n      trace.push(...result.trace.__obj);\n\n      if (result.passed) {\n        break;\n      }\n    }\n\n    const ms = startTimer.click();\n\n    tRoot.w('GRANTED ANY: [%s] (%d ms)', actions.join(' OR '), ms);\n\n    return {\n      ...result,\n      ms,\n      trace: {\n        toString: () => tRoot.collect(),\n        toJSON: () => obj.clone(trace),\n        __obj: trace\n      },\n      t: tRoot,\n    };\n  }\n\n  async _grantedMany(actions, options = {}) {\n    options = options || {};\n\n    actions = [...actions];\n\n    const allow = [];\n    const disallow = [];\n    const trace = [];\n    const tRoot = tbag();\n\n    let procActions = [...actions];\n    const startTimer = timer();\n\n    while(procActions.length > 0) {\n      const actionName = procActions.pop();\n\n      const opts = { ...options };\n\n      if (opts.timeout) {\n        opts.timeout = opts.timeout - startTimer.click();\n      }\n\n      let result = await this._granted(actionName, opts);\n\n      tRoot.childs.push(...result.t.childs);\n      trace.push(...result.trace.__obj);\n\n      if (result.passed) {\n        // take all actions from permission and exclude from processing list\n        procActions = array.pull(procActions, result.permission.actions);\n\n        allow.push(result);\n      } else {\n        disallow.push(result);\n      }\n    }\n\n    const ms = startTimer.click();\n\n    tRoot.w('GRANTED: [%s] (%d ms)', actions.join(' AND '), ms);\n\n    return {\n      allow,\n      disallow,\n      ms,\n      trace: {\n        toString: () => tRoot.collect(),\n        toJSON: () => obj.clone(trace),\n        __obj: trace\n      },\n      t: tRoot,\n    };\n  }\n\n  async _granted(actionName, options = {}) {\n    const {\n      enviroment = this._enviroment,\n      timeout = false,\n      context = {}\n    } = options || {};\n\n    const startTimer = timer();\n\n    const permissionsList = this._permissionsByActionMap.get(actionName) || [];\n\n    let permission = null;\n    let passed = false;\n    let mismatched = [];\n\n    const tRoot = tbag();\n    let trace = [];\n\n    const wholeContext = obj.clone(context);\n\n    const ensurePermissionVariables = async permission => {\n      for(const variableName of permission.ruleVariables) {\n        const contextValue = obj.get(wholeContext, variableName);\n\n        if (contextValue !== undefined) {\n          continue;\n        }\n\n        let enviromentValue = obj.get(enviroment, variableName);\n\n        if (typeof enviromentValue === 'function') {\n          try {\n            enviromentValue = await enviromentValue.call(enviroment);\n          } catch (err) {\n            enviromentValue = err;\n          }\n        }\n\n        obj.set(wholeContext, variableName, enviromentValue);\n      }\n    };\n\n    const handlePermission = async permission => {\n      await ensurePermissionVariables(permission);\n\n      const result = permission.check(wholeContext);\n\n      tRoot.attach(result.t);\n      result.t.w(' • TARGET = %s', actionName);\n\n      trace.push({\n        type: 'permission',\n        item: permission.toJSON(),\n        ...result\n      });\n\n      if (result.passed) {\n        passed = true;\n      } else {\n        mismatched.push(permission.toJSON());\n        permission = null;\n\n        await promiseDelay(0);\n      }\n    };\n\n    for(permission of permissionsList) {\n      if (timeout) {\n        const timeoutLeft = timeout - startTimer.click();\n\n        await promiseTimeout(\n          handlePermission(permission),\n          timeoutLeft,\n          `\"${actionName}\" reached execution timeout.`\n        );\n      } else {\n        await handlePermission(permission);\n      }\n\n      if (passed) break;\n    }\n\n    const ms = startTimer.click();\n\n    tRoot.w('GRANTED: [%s] (%d ms)', actionName, ms);\n\n    return {\n      passed,\n      permission: permission ? permission.toJSON() : null,\n      mismatched,\n      ms,\n      trace: {\n        toString: () => tRoot.collect(),\n        toJSON: () => obj.clone(trace),\n        __obj: trace\n      },\n      t: tRoot,\n    };\n  }\n}\n\n/*!\n * Helper for JSON.stringify\n */\nObject.defineProperty(Lilu.prototype, 'toJSON', {\n  enumerable: false,\n  writable: false,\n  configurable: true,\n  value: function() {\n    return {\n      name: this.name,\n      strict: this.strict,\n      operators: Object.keys(this._operators),\n      permissions: this.permissions.map(v => v.toJSON())\n    };\n  }\n});\n\nObject.defineProperty(Lilu.prototype, 'name', {\n  value: 'Lilu'\n});\n"],"names":["set","obj","path","value","Object","Array","isArray","toString","match","slice","reduce","a","c","i","Math","abs","length","get","defaultValue","undefined","travel","regexp","String","prototype","split","call","filter","Boolean","res","key","result","pick","list","uniq","arr","Set","pull","items","valuesToRemove","item","includes","promiseOrCallback","callback","fn","error","process","nextTick","apply","arguments","Promise","resolve","reject","promiseDelay","ms","setTimeout","LiluExpressionEvalError","Error","constructor","message","expressionText","context","code","name","inspect","assign","defineProperty","enumerable","writable","configurable","LiluExpressionParserError","LiluTimeoutError","promiseTimeout","promise","timeoutMillis","timeout","race","then","v","clearTimeout","err","timer","startAt","Date","now","instance","reset","click","EXPRESSION_REG_EXP","dParse","debug","dCast","parseExpression","str","_raw","matchResult","from","matchAll","parsed","variables","trim","type","castExpression","push","raw","extractEsprimaVariables","_parsed","_variables","array","expression","el","left","right","object","property","elements","_operators","ast","esprima","parse","body","evaluate","castType","_","d","dError","evalExpression","validate","strict","missedContextKey","find","keyPath","operator","leftValue","ensureValue","rightValue","operatorFn","ensured","validateExpression","some","indexOf","LiLuExpression","options","operators","EXPRESSION_OPERATORS","isValid","join","keys","format","fmt","args","re","replace","escaped","ptn","flag","arg","shift","Number","JSON","stringify","unshift","createTBag","rootChilds","lines","collect","childs","pad","p","padStart","rootCollect","w","line","attach","child","isChild","LiluPermissionRule","title","operation","conditions","map","cond","_conditionVariables","condition","flat","conditionVariables","trace","tRoot","tbag","tCond","matched","conditionRun","r","eval","toJSON","evalResult","matchTimer","every","t","sep","LiluPermission","actions","_attributes","attributes","rules","rule","_ruleVariables","ruleVariables","check","ruleRun","startTimer","isAllRulesPassed","passed","Lilu","_timeout","_enviroment","enviroment","_permissionsByActionMap","Map","_permissions","permissions","permissionOptions","permission","actionName","findActions","pattern","globToRegExp","extended","RegExp","TypeError","test","granted","params","cb","_granted","bind","grantedMany","_grantedMany","grantedAny","_grantedAny","opts","__obj","allow","disallow","procActions","pop","permissionsList","mismatched","wholeContext","ensurePermissionVariables","variableName","contextValue","enviromentValue","handlePermission","timeoutLeft"],"mappings":"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"}